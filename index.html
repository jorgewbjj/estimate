<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Field Report - Issue Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f4f6fb; }
    .container { max-width: 700px; margin: 40px auto; padding: 24px; background: #fff; border-radius: 16px; box-shadow: 0 3px 24px #0001; }
    h1 { margin-top: 0; }
    #map { height: 360px; border-radius: 12px; margin-bottom: 16px; }
    .issue-list { margin-top: 24px; }
    .issue-card { background: #f6faff; margin-bottom: 14px; padding: 12px 14px; border-radius: 10px; border: 1px solid #eef1f6; }
    .issue-card strong { display: block; }
    .issue-card small { color: #888; }
    label { font-weight: 600; }
    input, textarea, button { padding: 6px 10px; margin-top: 6px; font-size: 15px; border-radius: 7px; border: 1px solid #d7dae3; }
    button { background: #3874fa; color: #fff; border: none; font-weight: 600; cursor: pointer; }
    button:hover { background: #1d53c6; }
    .row { display: flex; gap: 10px; }
    @media (max-width: 700px) {
      .container { margin: 0; border-radius: 0; box-shadow: none; }
      #map { height: 240px; }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Field Report</h1>
  <div id="map"></div>

  <form id="issueForm" autocomplete="off">
    <label>Issue Description<br>
      <input type="text" id="desc" required placeholder="Describe the issue...">
    </label>
    <br>
    <label>Comments<br>
      <textarea id="comments" rows="2" placeholder="Optional comments..."></textarea>
    </label>
    <br>
    <button type="button" onclick="addIssue()">Add Issue at My Location</button>
    <span id="status" style="color:#d00;margin-left:10px"></span>
  </form>

  <div class="issue-list" id="issueList">
    <h2>Reported Issues</h2>
    <!-- Issues will be inserted here -->
  </div>
  <button onclick="downloadReport()" style="margin-top:20px;">Download Report (CSV)</button>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  let map = L.map('map').setView([0, 0], 2);
  let markers = [];
  let issues = [];

  // Add tile layer (OpenStreetMap)
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
  }).addTo(map);

  // Try to center map on user's location at start
  if ("geolocation" in navigator) {
    navigator.geolocation.getCurrentPosition(function(pos) {
      map.setView([pos.coords.latitude, pos.coords.longitude], 15);
    });
  }

  function addIssue() {
    const desc = document.getElementById('desc').value.trim();
    const comments = document.getElementById('comments').value.trim();
    const status = document.getElementById('status');
    status.textContent = '';

    if (!desc) {
      status.textContent = "Description required.";
      return;
    }

    if (!("geolocation" in navigator)) {
      status.textContent = "Geolocation not supported.";
      return;
    }

    status.textContent = "Getting location...";
    navigator.geolocation.getCurrentPosition(function(pos) {
      status.textContent = "";
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      // Add marker to map
      const marker = L.marker([lat, lng]).addTo(map)
        .bindPopup(`<strong>${desc}</strong><br>${comments ? comments : ""}<br><small>${lat.toFixed(6)}, ${lng.toFixed(6)}</small>`);
      markers.push(marker);

      // Save issue
      const issue = {
        desc, comments, lat, lng,
        timestamp: new Date().toLocaleString()
      };
      issues.push(issue);

      // Refresh issue list
      showIssues();
      // Reset form
      document.getElementById('issueForm').reset();
      // Center map on new marker
      map.setView([lat, lng], 16);

    }, function(err){
      status.textContent = "Location error: " + err.message;
    }, {
      enableHighAccuracy: true,
      timeout: 8000
    });
  }

  function showIssues() {
    const list = document.getElementById('issueList');
    if (!issues.length) {
      list.innerHTML = "<h2>Reported Issues</h2><em>No issues reported yet.</em>";
      return;
    }
    let html = '<h2>Reported Issues</h2>';
    issues.forEach((issue, i) => {
      html += `
        <div class="issue-card">
          <strong>#${i+1}: ${issue.desc}</strong>
          ${issue.comments ? `<div>üí¨ <em>${issue.comments}</em></div>` : ""}
          <small>üìç ${issue.lat.toFixed(6)}, ${issue.lng.toFixed(6)}<br>
          üïí ${issue.timestamp}</small>
        </div>
      `;
    });
    list.innerHTML = html;
  }

  function downloadReport() {
    if (!issues.length) {
      alert("No issues to export!");
      return;
    }
    const headers = ['Description', 'Comments', 'Latitude', 'Longitude', 'Timestamp'];
    const rows = [headers];
    issues.forEach(iss => {
      rows.push([
        iss.desc.replace(/"/g, '""'),
        iss.comments.replace(/"/g, '""'),
        iss.lat,
        iss.lng,
        iss.timestamp
      ]);
    });
    const csvContent = rows.map(r => r.map(cell => `"${cell}"`).join(',')).join('\n');
    const blob = new Blob([csvContent], {type:'text/csv'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'field_report.csv';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  showIssues();
</script>
</body>
</html>
