<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Field Report - Issue Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <!-- Cropper.js CSS -->
  <link href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.css" rel="stylesheet"/>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f4f6fb; }
    .container { max-width: 700px; margin: 40px auto; padding: 24px; background: #fff; border-radius: 16px; box-shadow: 0 3px 24px #0001; }
    h1 { margin-top: 0; }
    #map { height: 200px; border-radius: 12px; margin-bottom: 16px; }
    .issue-list { margin-top: 24px; }
    .issue-card { background: #f6faff; margin-bottom: 14px; padding: 12px 14px; border-radius: 10px; border: 1px solid #eef1f6; }
    .issue-card strong { display: block; }
    .issue-card small { color: #888; }
    label { font-weight: 600; }
    input, textarea, button { padding: 6px 10px; margin-top: 6px; font-size: 15px; border-radius: 7px; border: 1px solid #d7dae3; }
    textarea { min-height: 48px; resize: vertical; width: 100%; }
    button { background: #3874fa; color: #fff; border: none; font-weight: 600; cursor: pointer; }
    button:hover { background: #1d53c6; }
    .img-preview-group { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;}
    .img-preview { max-width: 100px; max-height: 66px; border-radius: 8px; border: 1px solid #ccc; object-fit: cover; }
    .marker-number {
      background: #3874fa;
      color: #fff;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      text-align: center;
      line-height: 30px;
      font-size: 16px;
      border: 2px solid #fff;
      box-shadow: 0 2px 6px #0004;
      font-weight: bold;
    }
    #cropperModal {
      position: fixed; z-index: 10000; left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center;
    }
    #cropperBox {
      background: #fff; border-radius: 12px; box-shadow: 0 2px 20px #0005; text-align: center;
      display: flex; flex-direction: column;
      max-width: 98vw; max-height: 94vh;
      width: 98vw; height: 94vh; padding: 0; position: relative;
    }
    #cropperBox h3 { margin: 16px 0 10px 0; font-size: 18px; }
    #cropperScroll { flex: 1 1 auto; overflow: auto; display: flex; align-items: center; justify-content: center; min-height: 0; min-width: 0; }
    #cropperImage { max-width: 96vw; max-height: 65vh; display: block; margin: 0 auto; background: #eee; }
    .cropper-btns {
      flex: none;
      background: #fff;
      padding: 12px 0 8px 0;
      border-radius: 0 0 12px 12px;
      box-shadow: 0 -2px 8px #0001;
      display: flex;
      justify-content: center;
      gap: 6px;
      position: sticky;
      bottom: 0; left: 0;
    }
    .cropper-btns button { margin: 0 1.5vw; }
    @media (max-width: 700px) {
      .container { margin: 0; border-radius: 0; box-shadow: none; }
      #map { height: 120px; }
      .img-preview { max-width: 46vw; }
      .img-preview-group { gap: 5px;}
      textarea { min-height: 38px; }
      #cropperBox { min-width: 0; }
      #cropperImage { max-width: 97vw; }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Field Report</h1>
  <div id="map"></div>

  <form id="issueForm" autocomplete="off">
    <label>Issue Description<br>
      <input type="text" id="desc" required placeholder="Describe the issue...">
    </label>
    <br>
    <label>Comments<br>
      <textarea id="comments" placeholder="Add any relevant comments or details (optional)"></textarea>
    </label>
    <br>
    <label>Pictures<br>
      <input type="file" id="picture" accept="image/*" multiple>
      <br>
      <div class="img-preview-group" id="imgPreviewGroup"></div>
    </label>
    <br>
    <button type="button" onclick="addIssue()">Add Issue at My Location</button>
    <span id="status" style="color:#d00;margin-left:10px"></span>
  </form>

  <div class="issue-list" id="issueList">
    <h2>Reported Issues</h2>
  </div>
  <button onclick="generatePDF()" style="margin-top:20px;">Download PDF Report</button>
</div>

<!-- Modal for cropping/rotation -->
<div id="cropperModal">
  <div id="cropperBox">
    <h3>Adjust Image (<span id="cropperCount"></span>)</h3>
    <div id="cropperScroll">
      <img id="cropperImage" alt="Cropper">
    </div>
    <div class="cropper-btns">
      <button onclick="rotateCropper(-90)" type="button">⟲ Rotate Left</button>
      <button onclick="rotateCropper(90)" type="button">⟳ Rotate Right</button>
      <button onclick="confirmCropper()" type="button" style="background:#3874fa;">Confirm</button>
      <button onclick="cancelCropper()" type="button" style="background:#ccc;color:#333;">Cancel</button>
    </div>
  </div>
</div>

<!-- Libraries -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.js"></script>
<script>
  let map = L.map('map').setView([0, 0], 21);
  let markers = [];
  let issues = [];
  let latestImages = [];

  // Esri Satellite Layer
  L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles &copy; Esri'
  }).addTo(map);

  function createNumberedDivIcon(number) {
    return L.divIcon({
      className: 'marker-number',
      html: number,
      iconSize: [30, 30],
      iconAnchor: [15, 30]
    });
  }

  function setMapToUser() {
    if ("geolocation" in navigator) {
      navigator.geolocation.getCurrentPosition(function(pos) {
        map.setView([pos.coords.latitude, pos.coords.longitude], 21);
      });
    }
  }
  setMapToUser();

  function resetPreview() {
    latestImages = [];
    document.getElementById('imgPreviewGroup').innerHTML = '';
    document.getElementById('picture').value = '';
  }

  // MULTI-CROP & ROTATE FUNCTIONALITY:
  let cropper = null, cropperFiles = [], cropperIndex = 0, tempImages = [];
  document.getElementById('picture').addEventListener('change', function(e) {
    cropperFiles = Array.from(e.target.files);
    cropperIndex = 0;
    tempImages = [];
    if (!cropperFiles.length) { resetPreview(); return; }
    startCropperProcess();
  });

  function startCropperProcess() {
    if (cropperIndex >= cropperFiles.length) {
      // All images done
      latestImages = tempImages.slice();
      // Show previews
      const group = document.getElementById('imgPreviewGroup');
      group.innerHTML = '';
      latestImages.forEach(src => {
        let img = document.createElement('img');
        img.className = 'img-preview';
        img.src = src;
        group.appendChild(img);
      });
      document.getElementById('cropperModal').style.display = 'none';
      if (cropper) { cropper.destroy(); cropper = null; }
      return;
    }
    const file = cropperFiles[cropperIndex];
    const reader = new FileReader();
    reader.onload = function(ev) {
      document.getElementById('cropperImage').src = ev.target.result;
      document.getElementById('cropperCount').textContent = (cropperIndex+1) + " / " + cropperFiles.length;
      document.getElementById('cropperModal').style.display = 'flex';
      if (cropper) { cropper.destroy(); }
      setTimeout(() => {
        cropper = new Cropper(document.getElementById('cropperImage'), {
          aspectRatio: 3/2,
          viewMode: 1,
          autoCropArea: 1,
          rotatable: true,
          movable: false,
          zoomable: false,
          responsive: true,
        });
      }, 60);
    };
    reader.readAsDataURL(file);
  }

  function rotateCropper(deg) {
    if (cropper) cropper.rotate(deg);
  }
  function cancelCropper() {
    if (cropper) { cropper.destroy(); cropper = null; }
    document.getElementById('cropperModal').style.display = 'none';
    resetPreview();
  }
  function confirmCropper() {
    if (!cropper) return;
    const canvas = cropper.getCroppedCanvas({width:900, height:600, fillColor:"#fff"});
    let dataURL = canvas.toDataURL('image/jpeg', 0.95);
    tempImages.push(dataURL);
    cropper.destroy(); cropper = null;
    cropperIndex++;
    startCropperProcess();
  }

  function addIssue() {
    const desc = document.getElementById('desc').value.trim();
    const comments = document.getElementById('comments').value.trim();
    const status = document.getElementById('status');
    status.textContent = '';
    if (!desc) {
      status.textContent = "Description required.";
      return;
    }
    if (!("geolocation" in navigator)) {
      status.textContent = "Geolocation not supported.";
      return;
    }
    status.textContent = "Getting location...";
    navigator.geolocation.getCurrentPosition(function(pos) {
      status.textContent = "";
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const marker = L.marker([lat, lng], {icon: createNumberedDivIcon(issues.length+1)})
        .addTo(map)
        .bindPopup(`<strong>#${issues.length+1}: ${desc}</strong><br>${comments ? comments : ""}<br><small>${lat.toFixed(6)}, ${lng.toFixed(6)}</small>`);
      markers.push(marker);
      const issue = {
        desc, comments, lat, lng,
        timestamp: new Date().toLocaleString(),
        images: latestImages.slice()
      };
      issues.push(issue);
      showIssues();
      document.getElementById('issueForm').reset();
      resetPreview();
      map.setView([lat, lng], 21);
    }, function(err){
      status.textContent = "Location error: " + err.message;
    }, { enableHighAccuracy: true, timeout: 8000 });
  }

  function showIssues() {
    markers.forEach(m => map.removeLayer(m));
    markers = [];
    issues.forEach((issue, idx) => {
      let marker = L.marker([issue.lat, issue.lng], {icon: createNumberedDivIcon(idx+1)})
        .addTo(map)
        .bindPopup(`<strong>#${idx+1}: ${issue.desc}</strong><br>${issue.comments ? issue.comments : ""}<br><small>${issue.lat.toFixed(6)}, ${issue.lng.toFixed(6)}</small>`);
      markers.push(marker);
    });
    const list = document.getElementById('issueList');
    if (!issues.length) {
      list.innerHTML = "<h2>Reported Issues</h2><em>No issues reported yet.</em>";
      return;
    }
    let html = '<h2>Reported Issues</h2>';
    issues.forEach((issue, i) => {
      html += `
        <div class="issue-card">
          <strong>#${i+1}: ${issue.desc}</strong>
          ${issue.comments ? `<div><b>Comment:</b> <em>${issue.comments}</em></div>` : ""}
          <small>📍 ${issue.lat.toFixed(6)}, ${issue.lng.toFixed(6)}<br>
          🕒 ${issue.timestamp}</small><br>
          <div class="img-preview-group">
            ${issue.images ? issue.images.map(src => `<img src="${src}" class="img-preview" alt="Issue Image">`).join('') : ''}
          </div>
        </div>
      `;
    });
    list.innerHTML = html;
  }

  async function generatePDF() {
    if (!issues.length) {
      alert("No issues to export!");
      return;
    }
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({orientation: 'portrait', unit: 'mm', format: 'a4'});
    let y = 20;
    pdf.setFontSize(20);
    pdf.text("Field Report", 15, y);
    y += 10;
    pdf.setFontSize(14);
    pdf.text("Reported Issues:", 15, y);
    y += 5;
    issues.forEach((issue, i) => {
      if (y > 210) { pdf.addPage(); y = 15; }
      pdf.setFontSize(12);
      pdf.text(`#${i+1}: ${issue.desc}`, 15, y); y += 7;
      if (issue.comments) {
        pdf.setFont("helvetica", "normal");
        pdf.text(`Comment: ${issue.comments}`, 18, y); y += 6;
      }
      pdf.text(`Location: ${issue.lat.toFixed(6)}, ${issue.lng.toFixed(6)}`, 18, y); y += 5;
      pdf.text(`Date: ${issue.timestamp}`, 18, y); y += 6;
      // Draw images 2 per row (90x60mm, landscape)
      if (issue.images && issue.images.length) {
        for(let idx=0; idx<issue.images.length; idx+=2) {
          let x1 = 18, x2 = 18+92;
          let w = 90, h = 60;
          pdf.addImage(issue.images[idx], 'JPEG', x1, y, w, h);
          if (idx+1 < issue.images.length) {
            pdf.addImage(issue.images[idx+1], 'JPEG', x2, y, w, h);
          }
          y += h + 4;
          if (y > 220 && (idx+2)<issue.images.length) { pdf.addPage(); y = 15; }
        }
      }
      y += 3;
    });

    // MAP OVERVIEW (last page)
    pdf.addPage();
    if (issues.length === 1) {
      map.setView([issues[0].lat, issues[0].lng], 21);
    } else if (issues.length > 1) {
      let latlngs = issues.map(iss => [iss.lat, iss.lng]);
      let bounds = L.latLngBounds(latlngs);
      map.fitBounds(bounds, {maxZoom: 21});
    }
    await new Promise(resolve => setTimeout(resolve, 700));
    const mapNode = document.getElementById('map');
    const scale = 3;
    const origWidth = mapNode.offsetWidth, origHeight = mapNode.offsetHeight;
    mapNode.style.width = (origWidth * scale) + "px";
    mapNode.style.height = (origHeight * scale) + "px";
    map.invalidateSize();
    await new Promise(resolve => setTimeout(resolve, 700));
    const mapCanvas = await html2canvas(mapNode, { useCORS: true, scale: scale });
    const mapImgData = mapCanvas.toDataURL('image/png');
    mapNode.style.width = origWidth + "px";
    mapNode.style.height = origHeight + "px";
    map.invalidateSize();
    pdf.setFontSize(20);
    pdf.text("Map Overview", 15, 18);
    const mapW = 140, mapH = 45;
    pdf.addImage(mapImgData, 'PNG', 15, 22, mapW, mapH);
    pdf.save('field_report.pdf');
    if (issues.length) {
      map.setView([issues[issues.length - 1].lat, issues[issues.length - 1].lng], 21);
    }
  }

  // Expose cropper modal controls
  window.rotateCropper = rotateCropper;
  window.cancelCropper = cancelCropper;
  window.confirmCropper = confirmCropper;

  showIssues();
</script>
</body>
</html>