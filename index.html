<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Field Report - Issue Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f4f6fb; }
    .container { max-width: 700px; margin: 40px auto; padding: 24px; background: #fff; border-radius: 16px; box-shadow: 0 3px 24px #0001; }
    h1 { margin-top: 0; }
    #map { height: 200px; border-radius: 12px; margin-bottom: 16px; }
    .issue-list { margin-top: 24px; }
    .issue-card { background: #f6faff; margin-bottom: 14px; padding: 12px 14px; border-radius: 10px; border: 1px solid #eef1f6; }
    .issue-card strong { display: block; }
    .issue-card small { color: #888; }
    label { font-weight: 600; }
    input, textarea, button { padding: 6px 10px; margin-top: 6px; font-size: 15px; border-radius: 7px; border: 1px solid #d7dae3; }
    button { background: #3874fa; color: #fff; border: none; font-weight: 600; cursor: pointer; }
    button:hover { background: #1d53c6; }
    .img-preview { max-width: 220px; max-height: 160px; margin-top: 8px; border-radius: 8px; border: 1px solid #ccc; }
    .row { display: flex; gap: 10px; }
    @media (max-width: 700px) {
      .container { margin: 0; border-radius: 0; box-shadow: none; }
      #map { height: 120px; }
      .img-preview { max-width: 90vw; }
    }
    .marker-number {
      background: #3874fa;
      color: #fff;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      text-align: center;
      line-height: 30px;
      font-size: 16px;
      border: 2px solid #fff;
      box-shadow: 0 2px 6px #0004;
      font-weight: bold;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Field Report</h1>
  <div id="map"></div>

  <form id="issueForm" autocomplete="off">
    <label>Issue Description<br>
      <input type="text" id="desc" required placeholder="Describe the issue...">
    </label>
    <br>
    <label>Comments<br>
      <textarea id="comments" rows="2" placeholder="Optional comments..."></textarea>
    </label>
    <br>
    <label>Picture<br>
      <input type="file" id="picture" accept="image/*">
      <br>
      <img id="imgPreview" class="img-preview" style="display:none;">
    </label>
    <br>
    <button type="button" onclick="addIssue()">Add Issue at My Location</button>
    <span id="status" style="color:#d00;margin-left:10px"></span>
  </form>

  <div class="issue-list" id="issueList">
    <h2>Reported Issues</h2>
  </div>
  <button onclick="generatePDF()" style="margin-top:20px;">Download PDF Report</button>
</div>

<!-- JS libraries -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
<script>
  let map = L.map('map').setView([0, 0], 2);
  let markers = [];
  let issues = [];
  let latestImage = null;
  let lastLat = 0, lastLng = 0;

  // Esri Satellite Layer
  L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles &copy; Esri'
  }).addTo(map);

  // Numbered marker icon generator
  function createNumberedDivIcon(number) {
    return L.divIcon({
      className: 'marker-number',
      html: number,
      iconSize: [30, 30],
      iconAnchor: [15, 30]
    });
  }

  // Geolocate and zoom very close
  function setMapToUser() {
    if ("geolocation" in navigator) {
      navigator.geolocation.getCurrentPosition(function(pos) {
        lastLat = pos.coords.latitude;
        lastLng = pos.coords.longitude;
        map.setView([lastLat, lastLng], 21); // Maximum supported
      });
    }
  }
  setMapToUser();

  // EXIF orientation fix + preview
  function resetPreview() {
    document.getElementById('imgPreview').src = '';
    document.getElementById('imgPreview').style.display = 'none';
    latestImage = null;
  }

  function getOrientationFixedDataURL(file, callback) {
    const reader = new FileReader();
    reader.onload = function(ev) {
      EXIF.getData(file, function() {
        let orientation = EXIF.getTag(this, "Orientation") || 1;
        let img = new window.Image();
        img.onload = function() {
          let canvas = document.createElement('canvas');
          let ctx = canvas.getContext('2d');
          let w = img.width, h = img.height;
          if (orientation > 4) { canvas.width = h; canvas.height = w; }
          else { canvas.width = w; canvas.height = h; }
          switch (orientation) {
            case 2: ctx.transform(-1, 0, 0, 1, w, 0); break;
            case 3: ctx.transform(-1, 0, 0, -1, w, h); break;
            case 4: ctx.transform(1, 0, 0, -1, 0, h); break;
            case 5: ctx.transform(0, 1, 1, 0, 0, 0); break;
            case 6: ctx.transform(0, 1, -1, 0, h, 0); break;
            case 7: ctx.transform(0, -1, -1, 0, h, w); break;
            case 8: ctx.transform(0, -1, 1, 0, 0, w); break;
            default: break;
          }
          ctx.drawImage(img, 0, 0);
          let dataURL = canvas.toDataURL('image/jpeg', 0.95);
          callback(dataURL);
        };
        img.src = ev.target.result;
      });
    };
    reader.readAsDataURL(file);
  }

  document.getElementById('picture').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) { resetPreview(); return; }
    getOrientationFixedDataURL(file, function(dataURL) {
      document.getElementById('imgPreview').src = dataURL;
      document.getElementById('imgPreview').style.display = 'inline-block';
      latestImage = dataURL;
    });
  });

  function addIssue() {
    const desc = document.getElementById('desc').value.trim();
    const comments = document.getElementById('comments').value.trim();
    const status = document.getElementById('status');
    status.textContent = '';

    if (!desc) {
      status.textContent = "Description required.";
      return;
    }

    if (!("geolocation" in navigator)) {
      status.textContent = "Geolocation not supported.";
      return;
    }

    status.textContent = "Getting location...";
    navigator.geolocation.getCurrentPosition(function(pos) {
      status.textContent = "";
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      lastLat = lat; lastLng = lng;
      map.setView([lat, lng], 21);

      // Add numbered marker to map
      const marker = L.marker([lat, lng], {icon: createNumberedDivIcon(issues.length+1)})
        .addTo(map)
        .bindPopup(`<strong>#${issues.length+1}: ${desc}</strong><br>${comments ? comments : ""}<br><small>${lat.toFixed(6)}, ${lng.toFixed(6)}</small>`);
      markers.push(marker);

      const issue = {
        desc, comments, lat, lng,
        timestamp: new Date().toLocaleString(),
        image: latestImage
      };
      issues.push(issue);

      showIssues();
      document.getElementById('issueForm').reset();
      resetPreview();
    }, function(err){
      status.textContent = "Location error: " + err.message;
    }, { enableHighAccuracy: true, timeout: 8000 });
  }

  function showIssues() {
    // Clear map markers and redraw all with numbers
    markers.forEach(m => map.removeLayer(m));
    markers = [];
    issues.forEach((issue, idx) => {
      let marker = L.marker([issue.lat, issue.lng], {icon: createNumberedDivIcon(idx+1)})
        .addTo(map)
        .bindPopup(`<strong>#${idx+1}: ${issue.desc}</strong><br>${issue.comments ? issue.comments : ""}<br><small>${issue.lat.toFixed(6)}, ${issue.lng.toFixed(6)}</small>`);
      markers.push(marker);
    });

    // Issue list
    const list = document.getElementById('issueList');
    if (!issues.length) {
      list.innerHTML = "<h2>Reported Issues</h2><em>No issues reported yet.</em>";
      return;
    }
    let html = '<h2>Reported Issues</h2>';
    issues.forEach((issue, i) => {
      html += `
        <div class="issue-card">
          <strong>#${i+1}: ${issue.desc}</strong>
          ${issue.comments ? `<div>üí¨ <em>${issue.comments}</em></div>` : ""}
          <small>üìç ${issue.lat.toFixed(6)}, ${issue.lng.toFixed(6)}<br>
          üïí ${issue.timestamp}</small><br>
          ${issue.image ? `<img src="${issue.image}" class="img-preview" alt="Issue Image">` : ""}
        </div>
      `;
    });
    list.innerHTML = html;
  }

  async function generatePDF() {
    if (!issues.length) {
      alert("No issues to export!");
      return;
    }

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({
      orientation: 'portrait',
      unit: 'mm',
      format: 'a4'
    });

    let y = 20;
    pdf.setFontSize(20);
    pdf.text("Field Report", 15, y);
    y += 10;

    let perPage = 0;
    pdf.setFontSize(14);
    pdf.text("Reported Issues:", 15, y);
    y += 5;

    issues.forEach((issue, i) => {
      if (y > 240) { pdf.addPage(); y = 15; }
      pdf.setFontSize(12);
      pdf.text(`#${i+1}: ${issue.desc}`, 15, y); y += 7;

      if (issue.comments) {
        pdf.setFont("helvetica", "italic");
        pdf.text(`üí¨ ${issue.comments}`, 18, y);
        pdf.setFont("helvetica", "normal");
        y += 6;
      }
      pdf.text(`Location: ${issue.lat.toFixed(6)}, ${issue.lng.toFixed(6)}`, 18, y); y += 5;
      pdf.text(`Date: ${issue.timestamp}`, 18, y); y += 6;

      if (issue.image) {
        let imgProps = pdf.getImageProperties(issue.image);
        let imgW = 90, imgH = (imgProps.height / imgProps.width) * imgW;
        if (imgH > 60) { imgH = 60; imgW = (imgProps.width / imgProps.height) * imgH; }
        pdf.addImage(issue.image, 'JPEG', 18, y, imgW, imgH);
        y += imgH + 4;
      }
      y += 3;
    });

    // MAP OVERVIEW (last page)
    pdf.addPage();

    // For high-res map snapshot
    const mapNode = document.getElementById('map');
    const scale = 3;
    const origWidth = mapNode.offsetWidth, origHeight = mapNode.offsetHeight;
    mapNode.style.width = (origWidth * scale) + "px";
    mapNode.style.height = (origHeight * scale) + "px";
    map.invalidateSize();
    await new Promise(resolve => setTimeout(resolve, 700));
    const mapCanvas = await html2canvas(mapNode, { useCORS: true, scale: scale });
    const mapImgData = mapCanvas.toDataURL('image/png');
    mapNode.style.width = origWidth + "px";
    mapNode.style.height = origHeight + "px";
    map.invalidateSize();

    pdf.setFontSize(20);
    pdf.text("Map Overview", 15, 18);
    const mapW = 140, mapH = 45;
    pdf.addImage(mapImgData, 'PNG', 15, 22, mapW, mapH);

    pdf.save('field_report.pdf');
  }

  showIssues();
</script>
</body>
</html>