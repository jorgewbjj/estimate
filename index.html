<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Field Report - Issue Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f4f6fb; }
    .container { max-width: 700px; margin: 40px auto; padding: 24px; background: #fff; border-radius: 16px; box-shadow: 0 3px 24px #0001; }
    h1 { margin-top: 0; }
    #map { height: 200px; border-radius: 12px; margin-bottom: 16px; }
    .issue-list { margin-top: 24px; }
    .issue-card { background: #f6faff; margin-bottom: 14px; padding: 12px 14px; border-radius: 10px; border: 1px solid #eef1f6; }
    .issue-card strong { display: block; }
    .issue-card small { color: #888; }
    label { font-weight: 600; }
    input, textarea, button { padding: 6px 10px; margin-top: 6px; font-size: 15px; border-radius: 7px; border: 1px solid #d7dae3; }
    button { background: #3874fa; color: #fff; border: none; font-weight: 600; cursor: pointer; }
    button:hover { background: #1d53c6; }
    .img-preview { max-width: 220px; max-height: 160px; margin-top: 8px; border-radius: 8px; border: 1px solid #ccc; }
    .row { display: flex; gap: 10px; }
    @media (max-width: 700px) {
      .container { margin: 0; border-radius: 0; box-shadow: none; }
      #map { height: 120px; }
      .img-preview { max-width: 90vw; }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Field Report</h1>
  <div id="map"></div>

  <form id="issueForm" autocomplete="off">
    <label>Issue Description<br>
      <input type="text" id="desc" required placeholder="Describe the issue...">
    </label>
    <br>
    <label>Comments<br>
      <textarea id="comments" rows="2" placeholder="Optional comments..."></textarea>
    </label>
    <br>
    <label>Picture<br>
      <input type="file" id="picture" accept="image/*">
      <br>
      <img id="imgPreview" class="img-preview" style="display:none;">
    </label>
    <br>
    <button type="button" onclick="addIssue()">Add Issue at My Location</button>
    <span id="status" style="color:#d00;margin-left:10px"></span>
  </form>

  <div class="issue-list" id="issueList">
    <h2>Reported Issues</h2>
    <!-- Issues will be inserted here -->
  </div>
  <button onclick="generatePDF()" style="margin-top:20px;">Download PDF Report</button>
</div>

<!-- JS libraries -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
<script>
  let map = L.map('map').setView([0, 0], 2);
  let markers = [];
  let issues = [];
  let latestImage = null;

  // Esri Satellite Layer
  L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles &copy; Esri'
  }).addTo(map);

  // Geolocate and zoom close
  function setMapToUser() {
    if ("geolocation" in navigator) {
      navigator.geolocation.getCurrentPosition(function(pos) {
        map.setView([pos.coords.latitude, pos.coords.longitude], 19); // building-level
      });
    }
  }
  setMapToUser();

  // EXIF orientation fix
  function resetPreview() {
    document.getElementById('imgPreview').src = '';
    document.getElementById('imgPreview').style.display = 'none';
    latestImage = null;
  }

  document.getElementById('picture').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) { resetPreview(); return; }

    const reader = new FileReader();
    reader.onload = function(ev) {
      // Read EXIF orientation
      EXIF.getData(file, function() {
        let orientation = EXIF.getTag(this, "Orientation") || 1;
        let img = new window.Image();
        img.onload = function() {
          let canvas = document.createElement('canvas');
          let ctx = canvas.getContext('2d');
          let w = img.width, h = img.height;
          // set proper canvas dimensions before transform
          if (orientation > 4) { canvas.width = h; canvas.height = w; }
          else { canvas.width = w; canvas.height = h; }
          // Transform context before drawing image
          switch (orientation) {
            case 2: ctx.transform(-1, 0, 0, 1, w, 0); break; // Mirror X
            case 3: ctx.transform(-1, 0, 0, -1, w, h); break; // 180¬∞
            case 4: ctx.transform(1, 0, 0, -1, 0, h); break; // Mirror Y
            case 5: ctx.transform(0, 1, 1, 0, 0, 0); break; // Mirror + rotate 90
            case 6: ctx.transform(0, 1, -1, 0, h, 0); break; // rotate 90
            case 7: ctx.transform(0, -1, -1, 0, h, w); break; // Mirror + rotate 270
            case 8: ctx.transform(0, -1, 1, 0, 0, w); break; // rotate 270
            default: break;
          }
          ctx.drawImage(img, 0, 0);

          let dataURL = canvas.toDataURL('image/jpeg', 0.95);
          document.getElementById('imgPreview').src = dataURL;
          document.getElementById('imgPreview').style.display = 'inline-block';
          latestImage = dataURL;
        };
        img.src = ev.target.result;
      });
    };
    reader.readAsDataURL(file);
  });

  function addIssue() {
    const desc = document.getElementById('desc').value.trim();
    const comments = document.getElementById('comments').value.trim();
    const status = document.getElementById('status');
    status.textContent = '';

    if (!desc) {
      status.textContent = "Description required.";
      return;
    }

    if (!("geolocation" in navigator)) {
      status.textContent = "Geolocation not supported.";
      return;
    }

    status.textContent = "Getting location...";
    navigator.geolocation.getCurrentPosition(function(pos) {
      status.textContent = "";
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      // Add marker to map
      const marker = L.marker([lat, lng]).addTo(map)
        .bindPopup(`<strong>${desc}</strong><br>${comments ? comments : ""}<br><small>${lat.toFixed(6)}, ${lng.toFixed(6)}</small>`);
      markers.push(marker);

      // Save issue (with image as dataURL)
      const issue = {
        desc, comments, lat, lng,
        timestamp: new Date().toLocaleString(),
        image: latestImage
      };
      issues.push(issue);

      // Refresh issue list
      showIssues();
      // Reset form
      document.getElementById('issueForm').reset();
      resetPreview();
      // Center/zoom map on new marker
      map.setView([lat, lng], 19);
    }, function(err){
      status.textContent = "Location error: " + err.message;
    }, { enableHighAccuracy: true, timeout: 8000 });
  }

  function showIssues() {
    const list = document.getElementById('issueList');
    if (!issues.length) {
      list.innerHTML = "<h2>Reported Issues</h2><em>No issues reported yet.</em>";
      return;
    }
    let html = '<h2>Reported Issues</h2>';
    issues.forEach((issue, i) => {
      html += `
        <div class="issue-card">
          <strong>#${i+1}: ${issue.desc}</strong>
          ${issue.comments ? `<div>üí¨ <em>${issue.comments}</em></div>` : ""}
          <small>üìç ${issue.lat.toFixed(6)}, ${issue.lng.toFixed(6)}<br>
          üïí ${issue.timestamp}</small><br>
          ${issue.image ? `<img src="${issue.image}" class="img-preview" alt="Issue Image">` : ""}
        </div>
      `;
    });
    list.innerHTML = html;
  }

  async function generatePDF() {
    if (!issues.length) {
      alert("No issues to export!");
      return;
    }

    // Make map image higher-res for PDF
    const mapNode = document.getElementById('map');
    const scale = 3;
    const origWidth = mapNode.offsetWidth, origHeight = mapNode.offsetHeight;
    mapNode.style.width = (origWidth * scale) + "px";
    mapNode.style.height = (origHeight * scale) + "px";
    map.invalidateSize();
    await new Promise(resolve => setTimeout(resolve, 600)); // let the map tiles load

    const mapCanvas = await html2canvas(mapNode, { useCORS: true, scale: scale });
    const mapImgData = mapCanvas.toDataURL('image/png');

    // Reset map to normal size
    mapNode.style.width = origWidth + "px";
    mapNode.style.height = origHeight + "px";
    map.invalidateSize();

    // PDF generation
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({
      orientation: 'portrait',
      unit: 'mm',
      format: 'a4'
    });

    pdf.setFontSize(20);
    pdf.text("Field Report", 15, 18);

    pdf.setFontSize(12);
    pdf.text("Map Overview:", 15, 28);
    const mapW = 140, mapH = 45;
    pdf.addImage(mapImgData, 'PNG', 15, 30, mapW, mapH);

    let y = 80;
    pdf.setFontSize(14);
    pdf.text("Reported Issues:", 15, y);
    y += 5;

    issues.forEach((issue, i) => {
      if (y > 260) { pdf.addPage(); y = 15; }

      pdf.setFontSize(12);
      pdf.text(`#${i+1}: ${issue.desc}`, 15, y);
      y += 7;

      if (issue.comments) {
        pdf.setFont("helvetica", "italic");
        pdf.text(`üí¨ ${issue.comments}`, 18, y);
        pdf.setFont("helvetica", "normal");
        y += 6;
      }
      pdf.text(`Location: ${issue.lat.toFixed(6)}, ${issue.lng.toFixed(6)}`, 18, y);
      y += 5;
      pdf.text(`Date: ${issue.timestamp}`, 18, y);
      y += 6;

      if (issue.image) {
        // Add image, larger now
        let imgProps = pdf.getImageProperties(issue.image);
        let imgW = 90, imgH = (imgProps.height / imgProps.width) * imgW;
        if (imgH > 60) { imgH = 60; imgW = (imgProps.width / imgProps.height) * imgH; }
        pdf.addImage(issue.image, 'JPEG', 18, y, imgW, imgH);
        y += imgH + 4;
      }
      y += 3;
    });

    pdf.save('field_report.pdf');
  }

  showIssues();
</script>
</body>
</html>
